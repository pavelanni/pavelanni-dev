<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>SSH login monitor | Pavel Anni</title>
<meta name="keywords" content="">
<meta name="description" content="How a random chat at work brought me to writing an SSH login monitor program using LLM">
<meta name="author" content="Pavel Anni">
<link rel="canonical" href="http://localhost:1313/projects/ssh_login_monitor/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/projects/ssh_login_monitor/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Pavel Anni (Alt + H)">Pavel Anni</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/projects/" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/texts/" title="Texts">
                    <span>Texts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/projects/">Projects</a></div>
    <h1 class="post-title entry-hint-parent">
      SSH login monitor
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-description">
      How a random chat at work brought me to writing an SSH login monitor program using LLM
    </div>
    <div class="post-meta"><span title='2023-04-27 00:00:00 +0000 UTC'>2023-04-27</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;2959 words&nbsp;·&nbsp;Pavel Anni

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" src="http://localhost:1313/projects/ssh_login_monitor/cover.webp" alt="">
        
</figure>
  <div class="post-content"><p>I noticed that a friend of mine routinely logs into his lab servers via SSH using the <code>root</code> username and password.</p>
<p>&ldquo;Why do you do that?&rdquo; I asked.</p>
<p>&ldquo;What’s wrong with that?&rdquo; he said. &ldquo;I know, I know, it’s not a good security practice, but I’m used to it.
It’s just a lab server; what can go wrong? And also, all other ways are not that easy.&rdquo;</p>
<p>&ldquo;&lsquo;What can go wrong?&rsquo;&rdquo; I said, &ldquo;The famous last words!&rdquo;
&ldquo;I’m not going to tell you horror stories. I just think that what you consider &rsquo;the most convenient way&rsquo; is not
that convenient. There are other ways.&rdquo;</p>
<p>&ldquo;Yeah, I know, I know,&rdquo; he sighed. &ldquo;Create a normal user, give them <code>sudo</code> access, and all that.&rdquo;</p>
<p>&ldquo;Yes, that’s the <em>right way</em>. You are correct.
Even better, that user shouldn’t use a password too. Using SSH keys is much better.
But if you insist on going <em>directly</em> as <code>root</code>, you can do it with SSH keys too.
The good thing about this approach is that you can always check who’s logged in as <code>root</code> with which key.&rdquo;</p>
<p>&ldquo;Really? Can you show me?&rdquo; he asked.</p>
<p>Challenge accepted.</p>
<h2 id="create-users">Create users<a hidden class="anchor" aria-hidden="true" href="#create-users">#</a></h2>
<p>I used one of my Red Hat servers as a target host.
I decided to start a simple Fedora Linux VM for the client host and create three normal users on it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[pavel@fedora ~]$ sudo useradd -m alice
</span></span><span style="display:flex;"><span>[pavel@fedora ~]$ sudo useradd -m bob
</span></span><span style="display:flex;"><span>[pavel@fedora ~]$ sudo useradd -m charlie
</span></span></code></pre></div><h2 id="create-ssh-keys">Create SSH keys<a hidden class="anchor" aria-hidden="true" href="#create-ssh-keys">#</a></h2>
<p>On behalf of each user, I created their SSH keys.
I decided to use the Ed25519 algorithm as it’s shorter and more secure than the default RSA.
(To learn more about this, just google &rsquo;ed25519 vs. rsa&rsquo;.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[pavel@fedora ~] $ sudo su - alice
</span></span><span style="display:flex;"><span>[alice@fedora ~] $ ssh-keygen -t ed25519
</span></span><span style="display:flex;"><span>Generating public/private ed25519 key pair.
</span></span><span style="display:flex;"><span>Enter file in which to save the key (/home/alice/.ssh/id_ed25519):
</span></span><span style="display:flex;"><span>Created directory &#39;/home/alice/.ssh&#39;.
</span></span><span style="display:flex;"><span>Enter passphrase (empty for no passphrase):
</span></span><span style="display:flex;"><span>Enter same passphrase again:
</span></span><span style="display:flex;"><span>Your identification has been saved in /home/alice/.ssh/id_ed25519
</span></span><span style="display:flex;"><span>Your public key has been saved in /home/alice/.ssh/id_ed25519.pub
</span></span><span style="display:flex;"><span>The key fingerprint is:
</span></span><span style="display:flex;"><span>SHA256:5xuxPx8QnPv19/6IZ5frmQj1N0hRCP9J364ddE6avL8 alice@fedora
</span></span><span style="display:flex;"><span>The key&#39;s randomart image is:
</span></span><span style="display:flex;"><span>+--[ED25519 256]--+
</span></span><span style="display:flex;"><span>|           .. .. |
</span></span><span style="display:flex;"><span>|           ..o.  |
</span></span><span style="display:flex;"><span>|            +o . |
</span></span><span style="display:flex;"><span>|             o+ +|
</span></span><span style="display:flex;"><span>|        S o oo +*|
</span></span><span style="display:flex;"><span>|         o oo++Bo|
</span></span><span style="display:flex;"><span>|          +. .*+B|
</span></span><span style="display:flex;"><span>|           +o.+BX|
</span></span><span style="display:flex;"><span>|          . o**EX|
</span></span><span style="display:flex;"><span>+----[SHA256]-----+
</span></span><span style="display:flex;"><span>[alice@fedora ~]$ cat .ssh/id_ed25519.pub
</span></span><span style="display:flex;"><span>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG8Obx1FsUu1jlYDtzfEDHYSDjG82xE7ysxZVzhgpGC5 alice@fedora
</span></span><span style="display:flex;"><span>[alice@fedora ~] $ exit
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[pavel@fedora ~] $ sudo su - bob
</span></span><span style="display:flex;"><span>[bob@fedora ~] $ ssh-keygen -t ed25519
</span></span><span style="display:flex;"><span>. . . . Same dialogue . . . .
</span></span><span style="display:flex;"><span>[bob@fedora ~] $ exit
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[pavel@fedora ~] $ sudo su - charlie
</span></span><span style="display:flex;"><span>[charlie@fedora ~] $ ssh-keygen -t ed25519
</span></span><span style="display:flex;"><span>. . . . Same dialogue . . . .
</span></span><span style="display:flex;"><span>[charlie@fedora ~] $ exit
</span></span></code></pre></div><h2 id="create-fingerprints">Create fingerprints<a hidden class="anchor" aria-hidden="true" href="#create-fingerprints">#</a></h2>
<p>I wore my sysadmin hat and told my users: &ldquo;I trust you. I want to give you root access to my server.
But I need your public keys.&rdquo;</p>
<p>&ldquo;Great!&rdquo; Alice, Bob, and Charlie answered. &ldquo;How can we do it?&rdquo;</p>
<p>&ldquo;Login to your accounts.
Your public key is this file: <code>~/.ssh/id_ed25519.pub</code>.
It’s just a one-line text file.
You can include it in the mail body or attach it as a file.
Remember: don’t share your <em>private</em> key&ndash;the one without <code>.pub</code>&ndash;with anybody!
Keep it private!&rdquo;</p>
<p>My users started working, and in several minutes, I received an email from each of them containing the following information:</p>
<pre tabindex="0"><code class="language-none" data-lang="none">From: alice
To: sysadmin
Subject: my public key

Hi Sysadmin,

Here is my public key (I copied it from id_ed25519.pub, as you told us):

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG8Obx1FsUu1jlYDtzfEDHYSDjG82xE7ysxZVzhgpGC5 alice@fedora

I hope this works.

Thanks,
Alice
</code></pre><h2 id="add-the-public-keys-to-the-host">Add the public keys to the host<a hidden class="anchor" aria-hidden="true" href="#add-the-public-keys-to-the-host">#</a></h2>
<p>The easiest way to give access to somebody to any account, including <code>root</code>, is to add that user’s public key to the file <code>.ssh/authorized_keys</code> in that account’s home directory.
This is exactly what I did for the <code>root</code> user on my lab server.
I opened (with Vim, of course) the file <code>/root/.ssh/authorized_keys</code> and entered these three entries (the public keys from my users):</p>
<pre tabindex="0"><code class="language-none" data-lang="none">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG8Obx1FsUu1jlYDtzfEDHYSDjG82xE7ysxZVzhgpGC5 alice@fedora
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJgclT4eQ5RlYabZfkdjFV5wGrroXxmd5n2X7okmiaN8 bob@fedora
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJWcjljox2NKwDFllZ5KQc4LSVrBEKoaOE/t/up1XbyD charlie@fedora
</code></pre><p>Now the system is ready for a test.</p>
<h2 id="test-access">Test access<a hidden class="anchor" aria-hidden="true" href="#test-access">#</a></h2>
<p>I went to my users and told them: &ldquo;The system is ready. Feel free to test your access!
The first time you login, the system will ask you if you trust the host you are logging in.
Answer <code>yes</code>. The host will be added to the list of known hosts&ndash;check it later in <code>~/.ssh/known_hosts</code>&ndash;
and next time, you won’t be asked for confirmation.&rdquo;</p>
<p>Alice, Bob, and Charlie opened their terminals on the Fedora machine and tried:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[bob@fedora ~] $ ssh -l root 192.168.1.234
</span></span><span style="display:flex;"><span>The authenticity of host &#39;192.168.1.234 (192.168.1.234)&#39; can&#39;t be established.
</span></span><span style="display:flex;"><span>ED25519 key fingerprint is SHA256:mhS0bPdGrEIwwMKJdKxpkxLdtYKNp0+FSgwqybeugd8.
</span></span><span style="display:flex;"><span>This key is not known by any other names
</span></span><span style="display:flex;"><span>Are you sure you want to continue connecting (yes/no/[fingerprint])? *(Bob typed &#39;yes&#39;)*
</span></span><span style="display:flex;"><span>Warning: Permanently added &#39;192.168.1.234&#39; (ED25519) to the list of known hosts.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Last login: Wed Apr 26 09:06:21 2023 from 192.168.1.24
</span></span><span style="display:flex;"><span>[root@rhel-lab ~]#
</span></span></code></pre></div><p>&ldquo;Wow! That was easy!&rdquo; Bob said. &ldquo;Look, no password!&rdquo;</p>
<p>&ldquo;I told you!&rdquo; I said.
&ldquo;But keep in mind: each of you comes to the server with your own key.
That means the server’s admin will always know who logged in as root: Alice, Bob, or Charlie.
So please be considerate when working as root on this host.&rdquo;</p>
<p>I said this to my users but wasn’t ready yet to watch their logins.
It was time to prepare.</p>
<h2 id="check-the-logs">Check the logs<a hidden class="anchor" aria-hidden="true" href="#check-the-logs">#</a></h2>
<p>&ldquo;They just logged in and out recently,&rdquo; I thought. &ldquo;It should be at the end of the log.&rdquo;</p>
<p>In Red Hat Enterprise Linux, the log file where all security-related events are stored is called <code>/var/log/secure.</code>
Let’s check its last 30 lines.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span># tail -30  /var/log/secure
</span></span><span style="display:flex;"><span>Apr 27 10:21:19 deep-rh sshd[1337250]: Accepted publickey for root from 192.168.1.24 port 49090 ssh2: ED25519 SHA256:5xuxPx8QnPv19/6IZ5frmQj1N0hRCP9J364ddE6avL8
</span></span><span style="display:flex;"><span>Apr 27 10:21:19 deep-rh systemd[1337257]: pam_unix(systemd-user:session): session opened for user root by (uid=0)
</span></span><span style="display:flex;"><span>Apr 27 10:21:19 deep-rh sshd[1337250]: pam_unix(sshd:session): session opened for user root by (uid=0)
</span></span><span style="display:flex;"><span>Apr 27 10:21:22 deep-rh sshd[1337282]: Received disconnect from 192.168.1.24 port 49090:11: disconnected by user
</span></span><span style="display:flex;"><span>Apr 27 10:21:22 deep-rh sshd[1337282]: Disconnected from user root 192.168.1.24 port 49090
</span></span><span style="display:flex;"><span>Apr 27 10:21:22 deep-rh sshd[1337250]: pam_unix(sshd:session): session closed for user root
</span></span><span style="display:flex;"><span>Apr 27 10:21:32 deep-rh systemd[1337261]: pam_unix(systemd-user:session): session closed for user root
</span></span><span style="display:flex;"><span>Apr 27 10:21:34 deep-rh sshd[1337458]: Accepted publickey for root from 192.168.1.24 port 41254 ssh2: ED25519 SHA256:is6l6bRqCCBVKunT+zVGHoUF0A06p8lt/04EoRbyCUY
</span></span><span style="display:flex;"><span>Apr 27 10:21:34 deep-rh systemd[1337467]: pam_unix(systemd-user:session): session opened for user root by (uid=0)
</span></span><span style="display:flex;"><span>Apr 27 10:21:34 deep-rh sshd[1337458]: pam_unix(sshd:session): session opened for user root by (uid=0)
</span></span><span style="display:flex;"><span>Apr 27 10:21:37 deep-rh sshd[1337493]: Received disconnect from 192.168.1.24 port 41254:11: disconnected by user
</span></span><span style="display:flex;"><span>Apr 27 10:21:37 deep-rh sshd[1337493]: Disconnected from user root 192.168.1.24 port 41254
</span></span><span style="display:flex;"><span>Apr 27 10:21:37 deep-rh sshd[1337458]: pam_unix(sshd:session): session closed for user root
</span></span><span style="display:flex;"><span>Apr 27 10:21:47 deep-rh systemd[1337472]: pam_unix(systemd-user:session): session closed for user root
</span></span><span style="display:flex;"><span>Apr 27 10:21:55 deep-rh sshd[1337680]: Accepted publickey for root from 192.168.1.24 port 42552 ssh2: ED25519 SHA256:QgAov0UZI25hWxnbLiHa00j64/zD1m80UMsSIZtxr2s
</span></span><span style="display:flex;"><span>Apr 27 10:21:55 deep-rh systemd[1337706]: pam_unix(systemd-user:session): session opened for user root by (uid=0)
</span></span><span style="display:flex;"><span>Apr 27 10:21:55 deep-rh sshd[1337680]: pam_unix(sshd:session): session opened for user root by (uid=0)
</span></span><span style="display:flex;"><span>Apr 27 10:21:58 deep-rh sshd[1337730]: Received disconnect from 192.168.1.24 port 42552:11: disconnected by user
</span></span><span style="display:flex;"><span>Apr 27 10:21:58 deep-rh sshd[1337730]: Disconnected from user root 192.168.1.24 port 42552
</span></span><span style="display:flex;"><span>Apr 27 10:21:58 deep-rh sshd[1337680]: pam_unix(sshd:session): session closed for user root
</span></span><span style="display:flex;"><span>Apr 27 10:22:08 deep-rh systemd[1337710]: pam_unix(systemd-user:session): session closed for user root
</span></span></code></pre></div><p>&ldquo;Good,&rdquo; I thought. &ldquo;I can see their logins and logouts. I can see the IPs from which they logged in.
But how can I figure out who logged in and when?&rdquo;</p>
<p>After a bit of googling, I found out that the string that goes after <code>ED25519 SHA256:</code> is a fingerprint of the user’s public key.
&ldquo;I just have to connect the fingerprints with the public keys,&rdquo; I thought.</p>
<h2 id="create-a-fingerprint-database">Create a fingerprint database<a hidden class="anchor" aria-hidden="true" href="#create-a-fingerprint-database">#</a></h2>
<p>Fingerprints are only useful if you have collected a good database of them.
This is what I did after receiving the emails from my users.</p>
<p>On the lab host (<code>rhel-lab</code>) I saved the users&rsquo; public keys in a separate directory under <code>/root</code>.
Of course, I made it readable only by root.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span># mkdir ~/ssh-keys
</span></span><span style="display:flex;"><span># chmod <span style="color:#ae81ff">0700</span> ~/ssh-keys
</span></span><span style="display:flex;"><span># cd ~/ssh-keys
</span></span></code></pre></div><p>I copied the users&rsquo; public keys that they sent me here and added the owner’s name to each file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span># echo <span style="color:#e6db74">&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG8Obx1FsUu1jlYDtzfEDHYSDjG82xE7ysxZVzhgpGC5 alice@fedora&#34;</span> &gt; alice_id_ed25519.pub
</span></span><span style="display:flex;"><span># echo <span style="color:#e6db74">&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJgclT4eQ5RlYabZfkdjFV5wGrroXxmd5n2X7okmiaN8 bob@fedora&#34;</span> &gt; bob_id_ed25519.pub
</span></span><span style="display:flex;"><span># echo <span style="color:#e6db74">&#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJWcjljox2NKwDFllZ5KQc4LSVrBEKoaOE/t/up1XbyD charlie@fedora&#34;</span> &gt; charlie_id_ed25519.pub
</span></span><span style="display:flex;"><span># ls -l *pub
</span></span><span style="display:flex;"><span>-rw-r--r--. 1 root root 94 Apr 27 09:53 alice_id_ed25519.pub
</span></span><span style="display:flex;"><span>-rw-r--r--. 1 root root 92 Apr 27 09:54 bob_id_ed25519.pub
</span></span><span style="display:flex;"><span>-rw-r--r--. 1 root root 96 Apr 27 09:54 charlie_id_ed25519.pub
</span></span></code></pre></div><p>Then I ran the following command against each public key file to create its fingerprint.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span># ssh-keygen -lf alice_id_ed25519.pub
</span></span><span style="display:flex;"><span>256 SHA256:5xuxPx8QnPv19/6IZ5frmQj1N0hRCP9J364ddE6avL8 alice@fedora (ED25519)
</span></span><span style="display:flex;"><span># ssh-keygen -lf bob_id_ed25519.pub
</span></span><span style="display:flex;"><span>256 SHA256:is6l6bRqCCBVKunT+zVGHoUF0A06p8lt/04EoRbyCUY bob@fedora (ED25519)
</span></span><span style="display:flex;"><span># ssh-keygen -lf charlie_id_ed25519.pub
</span></span><span style="display:flex;"><span>256 SHA256:QgAov0UZI25hWxnbLiHa00j64/zD1m80UMsSIZtxr2s charlie@fedora (ED25519)
</span></span></code></pre></div><p>In the same directory, I opened a file called <code>users.csv</code> and added three records in the form of <code>username,fingerprint</code>, like this:</p>
<p><strong>users.csv</strong></p>
<pre tabindex="0"><code class="language-none" data-lang="none">alice,5xuxPx8QnPv19/6IZ5frmQj1N0hRCP9J364ddE6avL8
bob,is6l6bRqCCBVKunT+zVGHoUF0A06p8lt/04EoRbyCUY
charlie,QgAov0UZI25hWxnbLiHa00j64/zD1m80UMsSIZtxr2s
</code></pre><p>Now I needed a program to scan the <code>/var/log/secure</code> file, find login and logout messages,
parse them to find the fingerprint, and look up the user based on their fingerprint in the database.</p>
<h2 id="create-a-log-monitoring-application">Create a log-monitoring application<a hidden class="anchor" aria-hidden="true" href="#create-a-log-monitoring-application">#</a></h2>
<p>I started learning Go recently, so for each new idea I try to use Go to practice.
So this problem looked like a good exercise.</p>
<p>The program’s logic is pretty simple:</p>
<ul>
<li>Scan the log file and create a list of login/logout events.</li>
<li>For each login event, find the user based on their fingerprint.</li>
<li>Create a list of sessions and add login events to it.</li>
<li>For each logout event, find the corresponding login event based on the source IP and the port and update the end time of the session.</li>
<li>Output all sessions with user names, source IPs, start/end times, and duration.</li>
</ul>
<p>The most challenging part was to parse the log file and collect all necessary fields.
That’s why the regular expressions might look scary.</p>
<p>I created a simple Go program consisting of a single <code>main.go</code> file and tested it on
a short fragment of <code>/var/log/secure</code> file.
It printed out this:</p>
<pre tabindex="0"><code class="language-none" data-lang="none"># go run main.go
alice   192.168.1.24    2023-04-27 10:21:19     2023-04-27 10:21:22     3s
bob     192.168.1.24    2023-04-27 10:21:34     2023-04-27 10:21:37     3s
charlie 192.168.1.24    2023-04-27 10:21:55     2023-04-27 10:21:58     3s
</code></pre><h2 id="use-ai-to-improve-the-application">Use AI to improve the application<a hidden class="anchor" aria-hidden="true" href="#use-ai-to-improve-the-application">#</a></h2>
<p>The first version of this app was a simple <code>main.go</code> file with hard-coded file names.
I was playing around and needed a simple demo.
My first improvement was adding the command-line arguments.
I added the <code>pflag</code> package (<a href="https://pkg.go.dev/github.com/spf13/pflag">https://pkg.go.dev/github.com/spf13/pflag</a>) and turned on Codeium (<a href="https://codeium.com/">https://codeium.com/</a>) in my VS Code.
And here, AI began to help me.</p>
<p>AI coding assistants are very impressive, no doubt.
But it’s one thing when you see it helping <em>somebody</em> in the video or you’re trying it yourself with some <em>example</em> programs.
And it’s another thing when you write something yourself, you work on your own project, and it starts really helping <em>you</em>.
Then you can clearly see how much time you saved by not typing a lot of things (just press [Tab] to accept!),
by not looking around your own code (what should be included in this <code>struct</code>, I forgot?), and by not googling function library definitions and arguments.
AI remembers all this for you.</p>
<p>Back to my code. I just started typing <code>userDB := flag.</code> and Codeium already knew that it should be <code>StringP</code> and the argument
should be named <code>users</code> (short form is <code>u</code>) and the reasonable default should be <code>users.csv</code>.
I didn’t argue and accepted.
The next argument was the same: I added the <code>log</code> argument almost without typing anything.</p>
<p>So far, so good. Let’s try another tool.
I opened ChatGPT and asked:</p>
<p><strong>Me</strong>: Act as a Go programming mentor. I will give you a program I wrote. Please suggest possible tests to add to this program.
Here is my program:</p>
<p>&hellip;and I pasted my simple <code>main.go</code> in the chat window.</p>
<p>In the answer it suggested several cases that I have to test with each function: valid input,
empty input, invalid input, duplicate fingerprints, etc.
At the end, ChatGPT gave me an example of how it can be done and added:</p>
<p><strong>AI</strong>: You can follow a similar pattern to write tests for the other functions as well.</p>
<p>Wow, it acted like a real mentor! It didn’t write the code <em>for me</em>, but it helped me to move in the right direction.</p>
<p>I wanted to write my tests the right way and played a role of a good student:</p>
<p><strong>Me</strong>: I read an article that suggested keeping the <code>main.go</code> file small and let the main function only call the application function.
They suggested having other functions in separate files and argued that it helps in testing.
Can you help me to apply these suggestions to my code?</p>
<p>&ldquo;Sure!&rdquo; the AI answered and suggested a good plan of moving all my functions to a
separate <code>pkg/sshloginmonitor</code> directory and creating files <code>user.go</code>, <code>session.go</code>, and <code>util.go</code>.</p>
<p>I followed the suggestion, and our discussion continued.</p>
<p><strong>Me</strong>: My program should log a fatal error under certain conditions. How should I test that?</p>
<p>In the answer it explained that it’s possible but I should keep in mind that the call to <code>log.Fatal()</code> will terminate my test.</p>
<p><strong>Me</strong>: Right! I shouldn’t call <code>log.Fatal()</code> from the function. I should return an error instead. How should I check the if the error is returned?</p>
<p>The AI gave me the full explanation with an example of how it should be done.</p>
<p><strong>Me</strong>: How should I specify the expected error in the lists of tests?</p>
<p>Another great example with a slice of test cases showing how to specify the expected error.</p>
<p><strong>Me</strong>: How should I test reading from a file? Can it be done by reading from a string constant?</p>
<p>Another great suggestion from AI: you probably should pass <code>io.Reader</code> to your function, not a file name.
That way, it will be much easier to test.
Accepted; I re-wrote my functions to use <code>io.Reader</code> instead of file names.</p>
<p>And so on, and so forth. Step by step, with the help of ChatGPT and Codeium, my little program
got the tests it needed, docstrings for functions, and test cases for different conditions.
In other words, in just a couple of hours, it looked much more professional.</p>
<p>I don’t know if AI can fully replace programmers.
But I’m sure it can help us write better code.
Just don’t be afraid and ask questions.</p>
<p>Find the code in this repo: <a href="https://github.com/pavelanni/ssh-login-monitor">https://github.com/pavelanni/ssh-login-monitor</a></p>
<hr>
<p>&ldquo;Wait,&rdquo; I thought. &ldquo;What if I give the AI the full description of my problem?
Will it be able to write it from scratch?&rdquo;</p>
<p>To be honest, I was a bit skeptical. Well, ChatGPT has impressed me already helping with my code here and there.
But to solve this problem from scratch, just from the problem description?
Probably not. But let’s give it a try.</p>
<h2 id="chatgpt-solves-the-problem">ChatGPT solves the problem<a hidden class="anchor" aria-hidden="true" href="#chatgpt-solves-the-problem">#</a></h2>
<p>I opened the ChatGPT window and typed the problem description.</p>
<p><img alt="The problem description" loading="lazy" src="/projects/ssh_login_monitor/problem.png"></p>
<p>I added the log (here is just a fragment).</p>
<p><img alt="Log fragment" loading="lazy" src="/projects/ssh_login_monitor/log.png"></p>
<p>And finally I added the <code>authorized_keys</code> file.</p>
<p><img alt="Authorized keys" loading="lazy" src="/projects/ssh_login_monitor/keys.png"></p>
<p>Let’s see what it can do with such a problem!</p>
<p>I didn’t wait for too long.
Almost immediately, ChatGPT started printing.
(The GPT-4 version prints a bit slower that GPT-3.5 and that creates an effect of &ldquo;thinking&rdquo;.
Also, it reminds me those old teletype machines used with <em>really</em> old computers.)</p>
<p><img alt="Fingerprint calculation" loading="lazy" src="/projects/ssh_login_monitor/fingerprint_calc.png"></p>
<p>Wait, what?? It’s just a language model!
How could it calculate the fingerprints??</p>
<p>But I didn’t have time to answer my own question because ChatGPT continued printing.</p>
<p><img alt="Login events" loading="lazy" src="/projects/ssh_login_monitor/login_events.png"></p>
<p>Well, it found the login events based on the string I gave it (him? her?) and connected the fingerprints to those it just calculated.
Impressive. It even found the timestamps and correctly presented them as timestamps.
Good job, but that’s easy.</p>
<p>Let’s continue and ask about logout events.</p>
<p><img alt="Logout events problem" loading="lazy" src="/projects/ssh_login_monitor/logout_events_problem.png"></p>
<p>Again, almost without a pause:</p>
<p><img alt="Logout events" loading="lazy" src="/projects/ssh_login_monitor/logout_events.png"></p>
<p>Good logic, great explanation! Find the ports and connect them to the login events.
That means it remembers the login events from the previous task somehow!
Mind blowing&hellip; But let’s continue.</p>
<p>If it remembers login and logout events, it should be able to calculate session durations.
Or not? Again, it’s just a language model, it should not know how to do arithmetics.
Let’s ask and see&hellip;</p>
<p><img alt="Session durations" loading="lazy" src="/projects/ssh_login_monitor/session_durations.png"></p>
<p>Wow! It even explained how it did the calculations! &ldquo;Show your work,&rdquo; as we were told in school.</p>
<p>I found myself sitting with a dropped jaw a few seconds later.
(No, it’s not just a figure of speech. Literally.)</p>
<p>For a few minutes I couldn’t collect my thoughts.
Yes, it’s a language model. Yes, it can find certain phrases and connect them together because
it has seen those phrases and words many times during training.
I understand that.</p>
<p>But how can it find numbers (like port numbers) and connect them together?
And how can it calculate?
Not only something simple like &ldquo;37 - 34&rdquo;, but an <em>SSH public key fingerprint</em>??
I can’t imagine that the model was trained on all possible public keys and their fingerprints, can you?</p>
<p>After several minutes of shock I got another great idea.
I had to close the loop.</p>
<p><img alt="Write a program" loading="lazy" src="/projects/ssh_login_monitor/write_program.png"></p>
<p>It wrote a piece of Go code, gave me instructions on how to run it, and how to pass
the input files to it.</p>
<p>Needless to say that I copied the code into my editor and ran it!</p>
<pre tabindex="0"><code class="language-none" data-lang="none">$ go run main.go ../test/secure.log ../test/authorized_keys
Login: alice - 0000-04-27 10:21:19 - 192.168.1.24:49090
Logout: alice - 0000-04-27 10:21:22 - 192.168.1.24:49090
Login: bob - 0000-04-27 10:21:34 - 192.168.1.24:41254
Logout: bob - 0000-04-27 10:21:37 - 192.168.1.24:41254
Login: charlie - 0000-04-27 10:21:55 - 192.168.1.24:42552
Logout: charlie - 0000-04-27 10:21:58 - 192.168.1.24:42552
</code></pre><p>One minor thing &ndash; it didn’t get the current year.
But it wasn’t in the log, so this is fine.
Now I’m pretty sure I could tell it to use the current year if it’s missing and it would do it perfectly.
No doubt.</p>
<p>The code written by ChatGPT is here: <a href="https://github.com/pavelanni/ssh-login-monitor/tree/main/chatgpt-version">https://github.com/pavelanni/ssh-login-monitor/tree/main/chatgpt-version</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/projects/time_circuits/">
    <span class="title">« Prev</span>
    <br>
    <span>Time circuits</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Pavel Anni</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
